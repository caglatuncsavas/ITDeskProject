ê
;C:\ITDeskProject\ITDeskServer\Abstractions\ApiController.cs
	namespace 	
ITDeskServer
 
. 
Abstractions #
;# $
[ 
Route 
( 
$str "
)" #
]# $
[ 
ApiController 
] 
[ 
	Authorize 

(
 !
AuthenticationSchemes  
=! "
$str# +
)+ ,
], -
public		 
abstract		 
class		 
ApiController		 #
:		# $
ControllerBase		$ 2
{

 
} é
5C:\ITDeskProject\ITDeskServer\Context\AppDbContext.cs
	namespace 	
ITDeskServer
 
. 
Context 
; 
public 
sealed 
class 
AppDbContext  
:! "
IdentityDbContext# 4
<4 5
AppUser5 <
,< =
AppRole> E
,E F
GuidG K
>K L
{		 
public

 

AppDbContext

 
(

 
DbContextOptions

 (
options

) 0
)

0 1
:

2 3
base

4 8
(

8 9
options

9 @
)

@ A
{ 
} 
public 

DbSet 
< 
Ticket 
> 
Tickets  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 

DbSet 
< 

TicketFile 
> 
TicketFiles (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 

DbSet 
< 
TicketDetail 
> 
TicketDetails ,
{- .
get/ 2
;2 3
set4 7
;7 8
}9 :
public 

DbSet 
< 
AppUserRole 
> 
AppUserRoles *
{+ ,
get- 0
;0 1
set2 5
;5 6
}7 8
override 
	protected 
void 
OnModelCreating +
(+ ,
ModelBuilder, 8
builder9 @
)@ A
{ 
builder 
. 
Entity 
< 
AppUserRole "
>" #
(# $
)$ %
.% &
HasKey& ,
(, -
p- .
=>/ 1
new2 5
{6 7
p8 9
.9 :
UserId: @
,@ A
pB C
.C D
RoleIdD J
}K L
)L M
;M N
builder 
. 
Ignore 
< 
IdentityUserRole '
<' (
Guid( ,
>, -
>- .
(. /
)/ 0
;0 1
builder 
. 
Ignore 
< 
IdentityRoleClaim (
<( )
Guid) -
>- .
>. /
(/ 0
)0 1
;1 2
builder 
. 
Ignore 
< 
IdentityUserClaim (
<( )
Guid) -
>- .
>. /
(/ 0
)0 1
;1 2
builder 
. 
Ignore 
< 
IdentityUserLogin (
<( )
Guid) -
>- .
>. /
(/ 0
)0 1
;1 2
builder 
. 
Ignore 
< 
IdentityUserToken (
<( )
Guid) -
>- .
>. /
(/ 0
)0 1
;1 2
} 
} ™P
;C:\ITDeskProject\ITDeskServer\Controllers\AuthController.cs
	namespace 	
ITDeskServer
 
. 
Controllers "
;" #
[ 
AllowAnonymous 
] 
public 
class 
AuthController 
( 
AppDbContext 
context 
, 
UserManager 
< 
AppUser 
> 
userManager $
,$ %
SignInManager 
< 
AppUser 
> 
signInManager (
,( )

JwtService 

jwtService 
) 
: 
ApiController *
{ 
[ 
HttpPost 
] 
public 

async 
Task 
< 
IActionResult #
># $
Login% *
(* +
LoginDto+ 3
request4 ;
,; <
CancellationToken= N
cancellationTokenO `
)` a
{ 
LoginValidator 
	validator  
=! "
new# &
(& '
)' (
;( )
ValidationResult   
validationResult   )
=  * +
	validator  , 5
.  5 6
Validate  6 >
(  > ?
request  ? F
)  F G
;  G H
if"" 

("" 
!"" 
validationResult"" 
."" 
IsValid"" %
)""% &
{## 	
return$$ 

StatusCode$$ 
($$ 
$num$$ !
,$$! "
validationResult$$" 2
.$$2 3
Errors$$3 9
.$$9 :
Select$$: @
($$@ A
s$$A B
=>$$B D
s$$E F
.$$F G
ErrorMessage$$G S
)$$S T
)$$T U
;$$U V
}%% 	
AppUser'' 
?'' 
appUser'' 
='' 
await''  %
userManager''& 1
.''1 2
FindByNameAsync''2 A
(''A B
request''B I
.''I J
UserNameOrEmail''J Y
)''Y Z
;''Z [
if(( 

((( 
appUser(( 
is(( 
null(( 
)(( 
{)) 	
appUser** 
=** 
await** 
userManager** '
.**' (
FindByEmailAsync**( 8
(**8 9
request**9 @
.**@ A
UserNameOrEmail**A P
)**P Q
;**Q R
if++ 
(++ 
appUser++ 
is++ 
null++ 
)++  
{,, 
return-- 

BadRequest-- !
(--! "
new--" %
{--& '
Message--( /
=--0 1
$str--2 I
}--J K
)--K L
;--L M
}.. 
}// 	
var11 

result11 
=11 
await11 
signInManager11 '
.11' ($
CheckPasswordSignInAsync11( @
(11@ A
appUser11A H
,11H I
request11J Q
.11Q R
Password11R Z
,11Z [
false11\ a
)11a b
;11b c
if33 

(33 
result33 
.33 
IsLockedOut33 
)33 
{44 	
TimeSpan55 
?55 
timeSpan55 
=55  
appUser55! (
.55( )

LockoutEnd55) 3
-554 5
DateTime556 >
.55> ?
UtcNow55? E
;55E F
if66 
(66 
timeSpan66 
is66 
not66 
null66 #
)66# $
{77 
return88 

BadRequest88 !
(88! "
new88" %
{88& '
Message88( /
=880 1
$"882 4
$str884 g
{88g h
Math88h l
.88l m
Ceiling88m t
(88t u
timeSpan88u }
.88} ~
Value	88~ ƒ
.
88ƒ „
TotalMinutes
88„ 
)
88 ‘
}
88‘ ’
$str
88’ £
"
88£ ¤
}
88¥ ¦
)
88¦ §
;
88§ ¨
}99 
};; 	
if== 

(== 
result== 
.== 
IsNotAllowed== 
)==  
{>> 	
return?? 

BadRequest?? 
(?? 
new?? !
{??" #
Message??$ +
=??, -
$str??. L
}??M N
)??N O
;??O P
}@@ 	
ifBB 

(BB 
!BB 
resultBB 
.BB 
	SucceededBB 
)BB 
{CC 	
returnDD 

BadRequestDD 
(DD 
newDD !
{DD" #
MessageDD$ +
=DD, -
$strDD. @
}DDA B
)DDB C
;DDC D
}EE 	
varGG 
rolesGG 
=GG 
contextHH 
.HH 
AppUserRolesHH  
.II 
WhereII 
(II 
pII 
=>II 
pII 
.II 
UserIdII  
==II! #
appUserII$ +
.II+ ,
IdII, .
)II. /
.JJ 
IncludeJJ 
(JJ 
pJJ 
=>JJ 
pJJ 
.JJ 
RoleJJ  
)JJ  !
.KK 
SelectKK 
(KK 
sKK 
=>KK 
sKK 
.KK 
RoleKK 
!KK  
.KK  !
NameKK! %
)KK% &
.LL 
ToListLL 
(LL 
)LL 
;LL 
stringNN 
tokenNN 
=NN 

jwtServiceNN !
.NN! "
CreateTokenNN" -
(NN- .
appUserNN. 5
,NN5 6
rolesNN7 <
,NN< =
requestNN> E
.NNE F

RememberMeNNF P
)NNP Q
;NNQ R
returnOO 
OkOO 
(OO 
newOO 
{OO 
AccessTokenOO "
=OO" #
tokenOO$ )
}OO* +
)OO+ ,
;OO, -
}PP 
[RR 
HttpPostRR 
]RR 
publicSS 

asyncSS 
TaskSS 
<SS 
IActionResultSS #
>SS# $
GoogleLoginSS% 0
(SS0 1
GoogleLoginDtoSS1 ?
requestSS@ G
,SSG H
CancellationTokenSSI Z
cancellationTokenSS[ l
)SSl m
{TT 
AppUserUU 
?UU 
appUserUU 
=UU 
awaitUU  
userManagerUU! ,
.UU, -
FindByEmailAsyncUU- =
(UU= >
requestUU> E
.UUE F
EmailUUF K
)UUK L
;UUL M
ifVV 

(VV
 
appUserVV 
isVV 
notVV 
nullVV 
)VV 
{WW 	
varXX 
rolesXX 
=XX 
contextYY
 
.YY 
AppUserRolesYY 
.ZZ
 
WhereZZ 
(ZZ 
pZZ 
=>ZZ 
pZZ 
.ZZ 
UserIdZZ 
==ZZ !
appUserZZ" )
.ZZ) *
IdZZ* ,
)ZZ, -
.[[
 
Include[[ 
([[ 
p[[ 
=>[[ 
p[[ 
.[[ 
Role[[ 
)[[ 
.\\
 
Select\\ 
(\\ 
s\\ 
=>\\ 
s\\ 
.\\ 
Role\\ 
!\\ 
.\\ 
Name\\ #
)\\# $
.]]
 
ToList]] 
(]] 
)]] 
;]] 
string__ 
token__ 
=__ 

jwtService__ %
.__% &
CreateToken__& 1
(__1 2
appUser__2 9
,__9 :
roles__; @
,__A B
true__B F
)__F G
;__G H
return`` 
Ok`` 
(`` 
new`` 
{`` 
AccessToken`` '
=``( )
token``* /
}``0 1
)``1 2
;``2 3
}aa 	
stringcc 
userNamecc 
=cc 
requestcc !
.cc! "
Emailcc" '
;cc' (
appUseree 
=ee 
newee 
(ee 
)ee 
{ff 
Emailgg 
=gg 
requestgg 
.gg  
Emailgg  %
,gg% &
	FirstNamehh 
=hh 
requesthh #
.hh# $
	FirstNamehh$ -
,hh- .
LastNameii 
=ii 
requestii "
.ii" #
LastNameii# +
,ii+ ,
UserNamejj 
=jj 
userNamejj #
,jj# $
GoogleProvideIdkk 
=kk  !
requestkk" )
.kk) *
Idkk* ,
}ll 
;ll 
IdentityResultnn 
resultnn 
=nn 
awaitnn #
userManagernn$ /
.nn/ 0
CreateAsyncnn0 ;
(nn; <
appUsernn< C
)nnC D
;nnD E
ifoo 

(oo
 
resultoo 
.oo 
	Succeededoo 
)oo 
{pp 	
stringqq 
tokenqq 
=qq 

jwtServiceqq %
.qq% &
CreateTokenqq& 1
(qq1 2
appUserqq2 9
,qq9 :
newqq; >
(qq> ?
)qq? @
,qqA B
trueqqB F
)qqF G
;qqG H
returnrr 
Okrr 
(rr 
newrr 
{rr 
AccessTokenrr '
=rr( )
tokenrr* /
}rr0 1
)rr1 2
;rr2 3
}ss 	
IdentityErroruu 
?uu 
errorResultuu "
=uu# $
resultuu% +
.uu+ ,
Errorsuu, 2
.uu2 3
FirstOrDefaultuu3 A
(uuA B
)uuB C
;uuC D
stringww 
errorMessageww 
=ww 
errorResultxx 
isxx 
nullxx 
?xx  !
$stryy R
:yyS T
errorResultzz 
.zz 
Descriptionzz #
;zz# $
return|| 

BadRequest|| 
(|| 
new|| 
{|| 
Message||  '
=||( )
errorMessage||* 6
}||7 8
)||8 9
;||9 :
}}} 
}~~ šx
>C:\ITDeskProject\ITDeskServer\Controllers\TicketsController.cs
	namespace 	
ITDeskServer
 
. 
Controllers "
;" #
public 
class 
TicketsController 
:  
ApiController! .
{ 
private 
readonly 
AppDbContext !
_context" *
;* +
public 

TicketsController 
( 
AppDbContext )
context* 1
)1 2
{ 
_context 
= 
context 
; 
} 
[ 
HttpPost 
] 
public 

IActionResult 
Add 
( 
[ 
FromForm &
]& '
TicketAddDto( 4
request5 <
)< =
{ 
string 
? 
userId 
= 
HttpContext $
.$ %
User% )
.) *
Claims* 0
.0 1
Where1 6
(6 7
p7 8
=>8 :
p; <
.< =
Type= A
==B D
$strE M
)M N
.N O
SelectO U
(U V
sV W
=>W Y
sZ [
.[ \
Value\ a
)a b
.b c
FirstOrDefaultc q
(q r
)r s
;s t
if 

(
 
userId 
is 
null 
) 
{ 	
return 

BadRequest 
( 
new !
{" #
Message$ +
=, -
$str. E
}F G
)G H
;H I
} 	
AppUser!! 
?!! 
appUser!! 
=!! 
_context!! "
.!!" #
Users!!# (
.!!( )
Where!!) .
(!!. /
p!!/ 0
=>!!0 2
p!!2 3
.!!3 4
Id!!4 6
==!!7 9
Guid!!: >
.!!> ?
Parse!!? D
(!!D E
userId!!E K
)!!K L
)!!L M
.!!M N
FirstOrDefault!!N \
(!!\ ]
)!!] ^
;!!^ _
if"" 

("" 
appUser"" 
is"" 
null"" 
)"" 
{## 	
return$$ 

BadRequest$$ 
($$ 
new$$ !
{$$" #
Message$$$ +
=$$, -
$str$$. E
}$$F G
)$$G H
;$$H I
}%% 	
Ticket'' 
ticket'' 
='' 
new'' 
('' 
)'' 
{(( 	
Id)) 
=)) 
Guid)) 
.)) 
NewGuid)) 
()) 
))) 
,))  
CreatedDate** 
=** 
DateTime** "
.**" #
Now**# &
,**& '
	AppUserId++ 
=++ 
Guid++ 
.++ 
Parse++  
(++  !
userId++! '
)++' (
,++( )
IsOpen,, 
=,, 
true,, 
,,, 
Subject-- 
=-- 
request-- 
.-- 
Subject-- #
,--# $
}.. 	
;..	 

if00 

(00
 
request00 
.00 
Files00 
is00 
not00 
null00  $
)00$ %
{11 	
ticket22 
.22 
FileUrls22 
=22 
new22 !
(22! "
)22" #
;22# $
foreach33 
(33 
var33 
file33 
in33 
request33  '
.33' (
Files33( -
)33- .
{44 
string55 

fileFormat55 !
=55! "
file55" &
.55& '
FileName55' /
.55/ 0
	Substring550 9
(559 :
file55: >
.55> ?
FileName55? G
.55G H
LastIndexOf55H S
(55S T
$char55T W
)55W X
)55X Y
;55Y Z
string66 
fileName66 
=66  !
Guid66" &
.66& '
NewGuid66' .
(66. /
)66/ 0
.660 1
ToString661 9
(669 :
)66: ;
+66< =

fileFormat66> H
;66H I
using77 
(77 
var77 
stream77 !
=77" #
System77$ *
.77* +
IO77+ -
.77- .
File77. 2
.772 3
Create773 9
(779 :
$str77: l
+77m n
fileName77o w
)77w x
)77x y
{88 
file99 
.99 
CopyTo99 
(99  
stream99  &
)99& '
;99' (
}:: 

TicketFile<< 

ticketFile<< %
=<<& '
new<<( +
(<<+ ,
)<<, -
{== 
Id>> 
=>> 
Guid>> 
.>> 
NewGuid>> %
(>>% &
)>>& '
,>>' (
TicketId?? 
=?? 
ticket?? %
.??% &
Id??& (
,??( )
FileUrl@@ 
=@@ 
fileName@@ &
}AA 
;AA 
ticketCC 
.CC 
FileUrlsCC 
?CC  
.CC  !
AddCC! $
(CC$ %

ticketFileCC% /
)CC/ 0
;CC0 1
}DD 
}EE 	
TicketDetailGG 
ticketDetailGG !
=GG" #
newGG$ '
(GG' (
)GG( )
{HH 	
IdII
 
=II 
GuidII 
.II 
NewGuidII 
(II 
)II 
,II 
	AppUserIdJJ
 
=JJ 
GuidJJ 
.JJ 
ParseJJ  
(JJ  !
userIdJJ! '
)JJ' (
,JJ( )
TicketIdKK
 
=KK 
ticketKK 
.KK 
IdKK 
,KK 
ContentLL
 
=LL 
requestLL 
.LL 
SummaryLL #
,LL# $
CreatedDateMM
 
=MM 
ticketMM 
.MM 
CreatedDateMM *
}NN 	
;NN	 

_contextPP 
.PP 
TicketsPP 
.PP 
AddPP 
(PP 
ticketPP #
)PP# $
;PP$ %
_contextQQ 
.QQ 
TicketDetailsQQ 
.QQ 
AddQQ "
(QQ" #
ticketDetailQQ# /
)QQ/ 0
;QQ0 1
_contextRR 
.RR 
SaveChangesRR 
(RR 
)RR 
;RR 
returnTT 
	NoContentTT 
(TT 
)TT 
;TT 
}UU 
[WW 
HttpGetWW 
(WW 
$strWW 
)WW 
]WW 
publicXX 

IActionResultXX 

GetDetailsXX #
(XX# $
GuidXX$ (
ticketIdXX) 1
)XX1 2
{YY 
varZZ 
detailsZZ 
=ZZ 
_context[[ 
.[[ 
TicketDetails[[ "
.\\ 
Where\\ 
(\\ 
p\\ 
=>\\ 
p\\ 
.\\ 
TicketId\\ "
==\\# %
ticketId\\& .
)\\. /
.]] 
Include]] 
(]] 
p]] 
=>]] 
p]] 
.]] 
AppUser]] #
)]]# $
.^^ 
OrderBy^^ 
(^^ 
p^^ 
=>^^ 
p^^ 
.^^ 
CreatedDate^^ '
)^^' (
.^^( )
ToList^^) /
(^^/ 0
)^^0 1
;^^1 2
return__ 
Ok__ 
(__ 
details__ 
)__ 
;__ 
}`` 
[bb 
HttpGetbb 
]bb 
publiccc 

IActionResultcc 
GetByIdcc  
(cc  !
Guidcc! %
ticketIdcc& .
)cc. /
{dd 
varee 
detailsee 
=ee 
_contextff 
.ff 
Ticketsff 
.gg 
Wheregg 
(gg 
pgg 
=>gg 
pgg 
.gg 
Idgg 
==gg 
ticketIdgg  (
)gg( )
.hh 
Includehh 
(hh 
phh 
=>hh 
phh 
.hh 
AppUserhh #
)hh# $
.ii 
Includeii 
(ii 
pii 
=>ii 
pii 
.ii 
FileUrlsii $
)ii$ %
.jj 
FirstOrDefaultjj 
(jj 
)jj 
;jj 
returnkk 
Okkk 
(kk 
detailskk 
)kk 
;kk 
}ll 
[nn 
HttpPostnn 
]nn 
publicoo 

IActionResultoo 
AddDetailContentoo )
(oo) *
TicketDetailDtooo* 9
requestoo: A
)ooA B
{pp 
Ticketqq 
?qq 
ticketqq 
=qq 
_contextrr 
.rr 
Ticketsrr 
.ss 
Wheress 
(ss 
pss 
=>ss 
pss 
.ss 
Idss 
==ss 
requestss &
.ss& '
TicketIdss' /
)ss/ 0
.tt 
FirstOrDefaulttt 
(tt 
)tt 
;tt 
ifvv 

(vv
 
ticketvv 
isvv 
notvv 
nullvv 
)vv 
{ww 	
ticketxx 
.xx 
IsOpenxx 
=xx 
truexx  
;xx  !
}yy 	
TicketDetail{{ 
ticketDetail{{ !
={{" #
new{{$ '
({{' (
){{( )
{|| 	
	AppUserId}} 
=}} 
request}} 
.}}  
	AppUserId}}  )
,}}) *
Content~~ 
=~~ 
request~~ 
.~~ 
Content~~ %
,~~% &
CreatedDate 
= 
DateTime "
." #
Now# &
,& '
TicketId
€€ 
=
€€ 
request
€€ 
.
€€ 
TicketId
€€ '
,
€€' (
}
 	
;
	 

_context
ƒƒ 
.
ƒƒ 
Add
ƒƒ 
(
ƒƒ 
ticketDetail
ƒƒ !
)
ƒƒ! "
;
ƒƒ" #
_context
„„ 
.
„„ 
SaveChanges
„„ 
(
„„ 
)
„„ 
;
„„ 
return
‡‡ 
	NoContent
‡‡ 
(
‡‡ 
)
‡‡ 
;
‡‡ 
}
ˆˆ 
[
‹‹ 
HttpPost
‹‹ 
]
‹‹ 
public
ŒŒ 

IActionResult
ŒŒ 
GetAll
ŒŒ 
(
ŒŒ  
GetAllTicketDto
ŒŒ  /
request
ŒŒ0 7
)
ŒŒ7 8
{
 
string
ŽŽ 
?
ŽŽ 
userId
ŽŽ 
=
ŽŽ 
HttpContext
ŽŽ #
.
ŽŽ# $
User
ŽŽ$ (
.
ŽŽ( )
Claims
ŽŽ) /
.
ŽŽ/ 0
Where
ŽŽ0 5
(
ŽŽ5 6
p
ŽŽ6 7
=>
ŽŽ7 9
p
ŽŽ: ;
.
ŽŽ; <
Type
ŽŽ< @
==
ŽŽA C
$str
ŽŽC K
)
ŽŽK L
.
ŽŽL M
Select
ŽŽM S
(
ŽŽS T
s
ŽŽT U
=>
ŽŽU W
s
ŽŽW X
.
ŽŽX Y
Value
ŽŽY ^
)
ŽŽ^ _
.
ŽŽ_ `
FirstOrDefault
ŽŽ` n
(
ŽŽn o
)
ŽŽo p
;
ŽŽp q
if
‘‘ 

(
‘‘
 
userId
‘‘ 
is
‘‘ 
null
‘‘ 
)
‘‘ 
{
’’ 	
return
““ 

BadRequest
““ 
(
““ 
new
““ !
{
““" #
Message
““$ +
=
““, -
$str
““. E
}
““F G
)
““G H
;
““H I
}
”” 	

IQueryable
•• 
<
•• 
TicketResponseDto
•• $
>
••$ %
tickets
••& -
=
••. /
_context
–– 
.
–– 
Tickets
–– 
.
—— 
Include
—— 
(
—— 
p
—— 
=>
—— 
p
—— 
.
—— 
AppUser
—— "
)
——" #
.
˜˜ 
Select
˜˜ 
(
˜˜ 
s
˜˜ 
=>
˜˜ 
new
˜˜ 
TicketResponseDto
˜˜ -
{
™™ 
Id
šš 
=
šš 
s
šš 
.
šš 
Id
šš 
,
šš 
	AppUserId
›› 
=
›› 
s
›› 
.
›› 
	AppUserId
›› &
,
››& '
AppUser
œœ 
=
œœ 
s
œœ 
.
œœ 
AppUser
œœ "
,
œœ" #
UserName
 
=
 
s
 
.
 
AppUser
 #
!
# $
.
$ %
UserName
% -
,
- .
CreatedDate
žž 
=
žž 
s
žž 
.
žž 
CreatedDate
žž *
.
žž* +
ToString
žž+ 3
(
žž3 4
$str
žž4 7
)
žž7 8
,
žž8 9
IsOpen
ŸŸ 
=
ŸŸ 
s
ŸŸ 
.
ŸŸ 
IsOpen
ŸŸ  
,
ŸŸ  !
Subject
   
=
   
s
   
.
   
Subject
   "
}
¡¡ 
)
¡¡ 
.
¢¢ 
AsQueryable
¢¢ 
(
¢¢ 
)
¢¢ 
;
¢¢ 
if
¤¤ 

(
¤¤ 
!
¤¤ 
request
¤¤ 
.
¤¤ 
Roles
¤¤ 
.
¤¤ 
Contains
¤¤ #
(
¤¤# $
$str
¤¤$ +
)
¤¤+ ,
)
¤¤, -
{
¥¥ 	
tickets
¦¦ 
=
¦¦ 
tickets
¦¦ 
.
¦¦ 
Where
¦¦ "
(
¦¦" #
p
¦¦# $
=>
¦¦% '
p
¦¦( )
.
¦¦) *
	AppUserId
¦¦* 3
==
¦¦4 6
Guid
¦¦7 ;
.
¦¦; <
Parse
¦¦< A
(
¦¦A B
userId
¦¦B H
)
¦¦H I
)
¦¦I J
;
¦¦J K
}
§§ 	
return
©© 
Ok
©© 
(
©© 
tickets
©© 
.
©© 
ToList
©©  
(
©©  !
)
©©! "
)
©©" #
;
©©# $
}
ªª 
[
¬¬ 
HttpGet
¬¬ 
]
¬¬ 
public
®® 

IActionResult
®® #
CloseTicketByTicketId
®® .
(
®®. /
Guid
®®/ 3
ticketId
®®4 <
)
®®< =
{
¯¯ 
Ticket
°° 
?
°° 
ticket
°° 
=
°° 
_context
°°  
.
°°  !
Tickets
°°! (
.
°°( )
Find
°°) -
(
°°- .
ticketId
°°. 6
)
°°6 7
;
°°7 8
if
±± 

(
±±
 
ticket
±± 
is
±± 
not
±± 
null
±± 
)
±± 
{
²² 	
ticket
³³ 
.
³³ 
IsOpen
³³ 
=
³³ 
false
³³ !
;
³³! "
_context
´´ 
.
´´ 
SaveChanges
´´  
(
´´  !
)
´´! "
;
´´" #
}
µµ 	
return
¶¶ 
	NoContent
¶¶ 
(
¶¶ 
)
¶¶ 
;
¶¶ 
}
·· 
}¸¸ ‘
=C:\ITDeskProject\ITDeskServer\Controllers\ValuesController.cs
	namespace 	
ITDeskServer
 
. 
Controllers "
;" #
public 
class 
ValuesController 
: 
ApiController  -
{		 
[

 
HttpGet

 
]

 
public 

IActionResult 
Get 
( 
) 
{ 
return 
Ok 
( 
new 
{ 
Message 
= 
$str  0
}0 1
)1 2
;2 3
} 
} Á
5C:\ITDeskProject\ITDeskServer\DTOs\GetAllTicketDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
record 
GetAllTicketDto $
($ %
string% +
Roles, 1
)1 2
;2 3¼	
4C:\ITDeskProject\ITDeskServer\DTOs\GoogleLoginDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
class 
GoogleLoginDto "
{ 
public 

string 
Id 
{ 
get 
; 
set 
;  
}! "
=# $
string% +
.+ ,
Empty, 1
;1 2
public 

string 
Email 
{ 
get 
; 
set "
;" #
}$ %
=& '
string( .
.. /
Empty/ 4
;4 5
public 

string 
	FirstName 
{ 
get !
;! "
set# &
;& '
}( )
=* +
string, 2
.2 3
Empty3 8
;8 9
public 

string 
LastName 
{ 
get  
;  !
set" %
;% &
}' (
=) *
string+ 1
.1 2
Empty2 7
;7 8
}		 Ñ
.C:\ITDeskProject\ITDeskServer\DTOs\LoginDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
record 
LoginDto 
( 
string 

UserNameOrEmail 
, 
string 

Password 
, 
bool 

RememberMe	 
= 
false 
) 
; í
2C:\ITDeskProject\ITDeskServer\DTOs\TicketAddDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
record 
TicketAddDto !
(! "
string 

Subject 
, 
string 

Summary 
, 
List 
< 	
	IFormFile	 
> 
? 
Files 
) 
; –
5C:\ITDeskProject\ITDeskServer\DTOs\TicketDetailDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
class 
TicketDetailDto 
{ 
public 

Guid 
TicketId 
{ 
get 
; 
set  #
;# $
}% &
public 

string 
Content 
{ 
get 
;  
set! $
;$ %
}& '
=( )
String* 0
.0 1
Empty1 6
;6 7
public		 

Guid		 
	AppUserId		 
{		 
get		 
;		  
set		! $
;		$ %
}		& '
}

 Š
7C:\ITDeskProject\ITDeskServer\DTOs\TicketResponseDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
record 
TicketResponseDto &
{ 
public 

Guid 
Id 
{ 
get 
; 
set 
; 
}  
public		 

Guid		 
	AppUserId		 
{		 
get		 
;		  
set		! $
;		$ %
}		& '
public

 

string

 
?

 
UserName

 
{

 
get

 !
;

! "
set

# &
;

& '
}

( )
public 

AppUser 
? 
AppUser 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
Subject 
{ 
get 
;  
set! $
;$ %
}& '
=( )
string) /
./ 0
Empty0 5
;5 6
public 

string 
CreatedDate 
{ 
get  #
;# $
set% (
;( )
}* +
=, -
string- 3
.3 4
Empty4 9
;9 :
public 

bool 
IsOpen 
{ 
get 
; 
set !
;! "
}# $
} É<
@C:\ITDeskProject\ITDeskServer\Middleware\ExtensionsMiddleware.cs
	namespace 	
ITDeskServer
 
. 

Middleware !
;! "
public 
static 
class  
ExtensionsMiddleware (
{		 
public

 

static

 
void

 
AutoMigration

 $
(

$ %
WebApplication

% 3
app

4 7
)

7 8
{ 
using 
( 
var 
scoped 
= 
app 
.  
Services  (
.( )
CreateScope) 4
(4 5
)5 6
)6 7
{ 	
var 
context 
= 
scoped  
.  !
ServiceProvider! 0
.0 1
GetRequiredService1 C
<C D
AppDbContextD P
>P Q
(Q R
)R S
;S T
context 
. 
Database 
. 
Migrate $
($ %
)% &
;& '
} 	
} 
public 

static 
void 
CreateFirstUser &
(& '
WebApplication' 5
app6 9
)9 :
{ 
using 
( 
var 
scoped 
= 
app 
.  
Services  (
.( )
CreateScope) 4
(4 5
)5 6
)6 7
{ 	
var 
userManager 
= 
scoped $
.$ %
ServiceProvider% 4
.4 5
GetRequiredService5 G
<G H
UserManagerH S
<S T
AppUserT [
>[ \
>\ ]
(] ^
)^ _
;_ `
if 
( 
! 
userManager 
. 
Users "
." #
Any# &
(& '
)' (
)( )
{ 
userManager 
. 
CreateAsync '
(' (
new( +
(+ ,
), -
{ 
Email 
= 
$str +
,+ ,
UserName 
= 
$str %
,% &
	FirstName 
= 
$str  $
,$ %
LastName 
= 
$str &
,& '
EmailConfirmed   "
=  # $
true  % )
,  ) *
}!! 
,!! 
$str!!  
)!!  !
.!!! "
Wait!!" &
(!!& '
)!!' (
;!!( )
}"" 
}## 	
}$$ 
public&& 

static&& 
void&& 
CreateRoles&& "
(&&" #
WebApplication&&# 1
app&&2 5
)&&5 6
{'' 
using(( 
((( 
var(( 
scoped(( 
=(( 
app(( 
.((  
Services((  (
.((( )
CreateScope(() 4
(((4 5
)((5 6
)((6 7
{)) 	
var** 
roleManager** 
=** 
scoped** $
.**$ %
ServiceProvider**% 4
.**4 5
GetRequiredService**5 G
<**G H
RoleManager**H S
<**S T
AppRole**T [
>**[ \
>**\ ]
(**] ^
)**^ _
;**_ `
if++ 
(++ 
!++ 
roleManager++ 
.++ 
Roles++ "
.++" #
Any++# &
(++& '
)++' (
)++( )
{,, 
roleManager-- 
.-- 
CreateAsync-- '
(--' (
new--( +
AppRole--, 3
(--3 4
)--4 5
{.. 
Id// 
=// 
Guid// 
.// 
NewGuid// "
(//" #
)//# $
,//$ %
Name00 
=00 
$str00 
,00  
NormalizedName11 !
=11! "
$str11" )
}22 
)22 
.22 
Wait22 
(22 
)22 
;22 
}33 
}44 	
}55 
public77 

static77 
void77 
CreateUserRoles77 &
(77& '
WebApplication77' 5
app776 9
)779 :
{88 
using99 
(99 
var99 
scoped99 
=99 
app99 
.99  
Services99  (
.99( )
CreateScope99) 4
(994 5
)995 6
)996 7
{:: 	
var;; 
context;; 
=;; 
scoped;; 
.;;  
ServiceProvider;;  /
.;;/ 0
GetRequiredService;;0 B
<;;B C
AppDbContext;;C O
>;;O P
(;;P Q
);;Q R
;;;R S
var<< 
userManager<< 
=<< 
scoped<< $
.<<$ %
ServiceProvider<<% 4
.<<4 5
GetRequiredService<<5 G
<<<G H
UserManager<<H S
<<<S T
AppUser<<T [
><<[ \
><<\ ]
(<<] ^
)<<^ _
;<<_ `
var== 
roleManager== 
=== 
scoped== $
.==$ %
ServiceProvider==% 4
.==4 5
GetRequiredService==5 G
<==G H
RoleManager==H S
<==S T
AppRole==T [
>==[ \
>==\ ]
(==] ^
)==^ _
;==_ `
AppUser?? 
??? 
user?? 
=?? 
userManager?? '
.??' (
Users??( -
.??- .
FirstOrDefault??. <
(??< =
p??= >
=>??? A
p??B C
.??C D
Email??D I
==??J L
$str??M \
)??\ ]
;??] ^
if@@ 
(@@ 
user@@ 
is@@ 
not@@ 
null@@ 
)@@  
{AA 
AppRoleBB 
?BB 
roleBB 
=BB 
roleManagerBB  +
.BB+ ,
RolesBB, 1
.BB1 2
FirstOrDefaultBB2 @
(BB@ A
pBBA B
=>BBC E
pBBF G
.BBG H
NameBBH L
==BBM O
$strBBP W
)BBW X
;BBX Y
ifCC 
(CC 
roleCC 
isCC 
notCC 
nullCC #
)CC# $
{DD 
boolEE 
userRoleExistEE &
=EE' (
contextEE) 0
.EE0 1
AppUserRolesEE1 =
.EE= >
AnyEE> A
(EEA B
pEEB C
=>EEC E
pEEE F
.EEF G
RoleIdEEG M
==EEN P
roleEEQ U
.EEU V
IdEEV X
&&EEY [
pEE\ ]
.EE] ^
UserIdEE^ d
==EEe g
userEEh l
.EEl m
IdEEm o
)EEo p
;EEp q
ifFF 
(FF 
!FF 
userRoleExistFF &
)FF& '
{GG 
AppUserRoleHH #
appUserRoleHH$ /
=HH0 1
newHH2 5
(HH5 6
)HH6 7
{II 
RoleIdJJ "
=JJ# $
roleJJ% )
.JJ) *
IdJJ* ,
,JJ, -
UserIdKK "
=KK# $
userKK% )
.KK) *
IdKK* ,
}LL 
;LL 
contextMM 
.MM  
AppUserRolesMM  ,
.MM, -
AddMM- 0
(MM0 1
appUserRoleMM1 <
)MM< =
;MM= >
contextNN 
.NN  
SaveChangesNN  +
(NN+ ,
)NN, -
;NN- .
}OO 
}RR 
}SS 
}TT 	
}UU 
}VV °‹
>C:\ITDeskProject\ITDeskServer\Migrations\20231218221527_mg1.cs
	namespace 	
ITDeskServer
 
. 

Migrations !
{ 
public		 

partial		 
class		 
mg1		 
:		 
	Migration		 (
{

 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str 
, 
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
Guid& *
>* +
(+ ,
type, 0
:0 1
$str2 D
,D E
nullableF N
:N O
falseP U
)U V
,V W
Name 
= 
table  
.  !
Column! '
<' (
string( .
>. /
(/ 0
type0 4
:4 5
$str6 E
,E F
nullableG O
:O P
trueQ U
)U V
,V W
NormalizedName "
=# $
table% *
.* +
Column+ 1
<1 2
string2 8
>8 9
(9 :
type: >
:> ?
$str@ O
,O P
nullableQ Y
:Y Z
true[ _
)_ `
,` a
ConcurrencyStamp $
=% &
table' ,
., -
Column- 3
<3 4
string4 :
>: ;
(; <
type< @
:@ A
$strB Q
,Q R
nullableS [
:[ \
true] a
)a b
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% /
,/ 0
x1 2
=>3 5
x6 7
.7 8
Id8 :
): ;
;; <
} 
) 
; 
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str 
, 
columns 
: 
table 
=> !
new" %
{ 
Id   
=   
table   
.   
Column   %
<  % &
Guid  & *
>  * +
(  + ,
type  , 0
:  0 1
$str  2 D
,  D E
nullable  F N
:  N O
false  P U
)  U V
,  V W
	FirstName!! 
=!! 
table!!  %
.!!% &
Column!!& ,
<!!, -
string!!- 3
>!!3 4
(!!4 5
type!!5 9
:!!9 :
$str!!; J
,!!J K
nullable!!L T
:!!T U
false!!V [
)!![ \
,!!\ ]
LastName"" 
="" 
table"" $
.""$ %
Column""% +
<""+ ,
string"", 2
>""2 3
(""3 4
type""4 8
:""8 9
$str"": I
,""I J
nullable""K S
:""S T
false""U Z
)""Z [
,""[ \
GoogleProvideId## #
=##$ %
table##& +
.##+ ,
Column##, 2
<##2 3
string##3 9
>##9 :
(##: ;
type##; ?
:##? @
$str##A P
,##P Q
nullable##R Z
:##Z [
true##\ `
)##` a
,##a b
UserName$$ 
=$$ 
table$$ $
.$$$ %
Column$$% +
<$$+ ,
string$$, 2
>$$2 3
($$3 4
type$$4 8
:$$8 9
$str$$: I
,$$I J
nullable$$K S
:$$S T
true$$U Y
)$$Y Z
,$$Z [
NormalizedUserName%% &
=%%' (
table%%) .
.%%. /
Column%%/ 5
<%%5 6
string%%6 <
>%%< =
(%%= >
type%%> B
:%%B C
$str%%D S
,%%S T
nullable%%U ]
:%%] ^
true%%_ c
)%%c d
,%%d e
Email&& 
=&& 
table&& !
.&&! "
Column&&" (
<&&( )
string&&) /
>&&/ 0
(&&0 1
type&&1 5
:&&5 6
$str&&7 F
,&&F G
nullable&&H P
:&&P Q
true&&R V
)&&V W
,&&W X
NormalizedEmail'' #
=''$ %
table''& +
.''+ ,
Column'', 2
<''2 3
string''3 9
>''9 :
('': ;
type''; ?
:''? @
$str''A P
,''P Q
nullable''R Z
:''Z [
true''\ `
)''` a
,''a b
EmailConfirmed(( "
=((# $
table((% *
.((* +
Column((+ 1
<((1 2
bool((2 6
>((6 7
(((7 8
type((8 <
:((< =
$str((> C
,((C D
nullable((E M
:((M N
false((O T
)((T U
,((U V
PasswordHash))  
=))! "
table))# (
.))( )
Column))) /
<))/ 0
string))0 6
>))6 7
())7 8
type))8 <
:))< =
$str))> M
,))M N
nullable))O W
:))W X
true))Y ]
)))] ^
,))^ _
SecurityStamp** !
=**" #
table**$ )
.**) *
Column*** 0
<**0 1
string**1 7
>**7 8
(**8 9
type**9 =
:**= >
$str**? N
,**N O
nullable**P X
:**X Y
true**Z ^
)**^ _
,**_ `
ConcurrencyStamp++ $
=++% &
table++' ,
.++, -
Column++- 3
<++3 4
string++4 :
>++: ;
(++; <
type++< @
:++@ A
$str++B Q
,++Q R
nullable++S [
:++[ \
true++] a
)++a b
,++b c
PhoneNumber,, 
=,,  !
table,," '
.,,' (
Column,,( .
<,,. /
string,,/ 5
>,,5 6
(,,6 7
type,,7 ;
:,,; <
$str,,= L
,,,L M
nullable,,N V
:,,V W
true,,X \
),,\ ]
,,,] ^
TwoFactorEnabled-- $
=--% &
table--' ,
.--, -
Column--- 3
<--3 4
bool--4 8
>--8 9
(--9 :
type--: >
:--> ?
$str--@ E
,--E F
nullable--G O
:--O P
false--Q V
)--V W
,--W X

LockoutEnd.. 
=..  
table..! &
...& '
Column..' -
<..- .
DateTimeOffset... <
>..< =
(..= >
type..> B
:..B C
$str..D T
,..T U
nullable..V ^
:..^ _
true..` d
)..d e
,..e f
LockoutEnabled// "
=//# $
table//% *
.//* +
Column//+ 1
<//1 2
bool//2 6
>//6 7
(//7 8
type//8 <
://< =
$str//> C
,//C D
nullable//E M
://M N
false//O T
)//T U
,//U V
AccessFailedCount00 %
=00& '
table00( -
.00- .
Column00. 4
<004 5
int005 8
>008 9
(009 :
type00: >
:00> ?
$str00@ E
,00E F
nullable00G O
:00O P
false00Q V
)00V W
}11 
,11 
constraints22 
:22 
table22 "
=>22# %
{33 
table44 
.44 

PrimaryKey44 $
(44$ %
$str44% /
,44/ 0
x441 2
=>443 5
x446 7
.447 8
Id448 :
)44: ;
;44; <
}55 
)55 
;55 
migrationBuilder77 
.77 
CreateTable77 (
(77( )
name88 
:88 
$str88 %
,88% &
columns99 
:99 
table99 
=>99 !
new99" %
{:: 
Id;; 
=;; 
table;; 
.;; 
Column;; %
<;;% &
Guid;;& *
>;;* +
(;;+ ,
type;;, 0
:;;0 1
$str;;2 D
,;;D E
nullable;;F N
:;;N O
false;;P U
);;U V
,;;V W
TicketId<< 
=<< 
table<< $
.<<$ %
Column<<% +
<<<+ ,
Guid<<, 0
><<0 1
(<<1 2
type<<2 6
:<<6 7
$str<<8 J
,<<J K
nullable<<L T
:<<T U
false<<V [
)<<[ \
,<<\ ]
	AppUserId== 
=== 
table==  %
.==% &
Column==& ,
<==, -
Guid==- 1
>==1 2
(==2 3
type==3 7
:==7 8
$str==9 K
,==K L
nullable==M U
:==U V
false==W \
)==\ ]
,==] ^
Content>> 
=>> 
table>> #
.>># $
Column>>$ *
<>>* +
string>>+ 1
>>>1 2
(>>2 3
type>>3 7
:>>7 8
$str>>9 H
,>>H I
nullable>>J R
:>>R S
false>>T Y
)>>Y Z
,>>Z [
CreatedDate?? 
=??  !
table??" '
.??' (
Column??( .
<??. /
DateTime??/ 7
>??7 8
(??8 9
type??9 =
:??= >
$str??? J
,??J K
nullable??L T
:??T U
false??V [
)??[ \
}@@ 
,@@ 
constraintsAA 
:AA 
tableAA "
=>AA# %
{BB 
tableCC 
.CC 

PrimaryKeyCC $
(CC$ %
$strCC% 7
,CC7 8
xCC9 :
=>CC; =
xCC> ?
.CC? @
IdCC@ B
)CCB C
;CCC D
tableDD 
.DD 

ForeignKeyDD $
(DD$ %
nameEE 
:EE 
$strEE @
,EE@ A
columnFF 
:FF 
xFF  !
=>FF" $
xFF% &
.FF& '
	AppUserIdFF' 0
,FF0 1
principalTableGG &
:GG& '
$strGG( /
,GG/ 0
principalColumnHH '
:HH' (
$strHH) -
,HH- .
onDeleteII  
:II  !
ReferentialActionII" 3
.II3 4
CascadeII4 ;
)II; <
;II< =
}JJ 
)JJ 
;JJ 
migrationBuilderLL 
.LL 
CreateTableLL (
(LL( )
nameMM 
:MM 
$strMM 
,MM  
columnsNN 
:NN 
tableNN 
=>NN !
newNN" %
{OO 
IdPP 
=PP 
tablePP 
.PP 
ColumnPP %
<PP% &
GuidPP& *
>PP* +
(PP+ ,
typePP, 0
:PP0 1
$strPP2 D
,PPD E
nullablePPF N
:PPN O
falsePPP U
)PPU V
,PPV W
	AppUserIdQQ 
=QQ 
tableQQ  %
.QQ% &
ColumnQQ& ,
<QQ, -
GuidQQ- 1
>QQ1 2
(QQ2 3
typeQQ3 7
:QQ7 8
$strQQ9 K
,QQK L
nullableQQM U
:QQU V
falseQQW \
)QQ\ ]
,QQ] ^
SubjectRR 
=RR 
tableRR #
.RR# $
ColumnRR$ *
<RR* +
stringRR+ 1
>RR1 2
(RR2 3
typeRR3 7
:RR7 8
$strRR9 H
,RRH I
nullableRRJ R
:RRR S
falseRRT Y
)RRY Z
,RRZ [
CreatedDateSS 
=SS  !
tableSS" '
.SS' (
ColumnSS( .
<SS. /
DateTimeSS/ 7
>SS7 8
(SS8 9
typeSS9 =
:SS= >
$strSS? J
,SSJ K
nullableSSL T
:SST U
falseSSV [
)SS[ \
,SS\ ]
IsOpenTT 
=TT 
tableTT "
.TT" #
ColumnTT# )
<TT) *
boolTT* .
>TT. /
(TT/ 0
typeTT0 4
:TT4 5
$strTT6 ;
,TT; <
nullableTT= E
:TTE F
falseTTG L
)TTL M
}UU 
,UU 
constraintsVV 
:VV 
tableVV "
=>VV# %
{WW 
tableXX 
.XX 

PrimaryKeyXX $
(XX$ %
$strXX% 1
,XX1 2
xXX3 4
=>XX5 7
xXX8 9
.XX9 :
IdXX: <
)XX< =
;XX= >
tableYY 
.YY 

ForeignKeyYY $
(YY$ %
nameZZ 
:ZZ 
$strZZ :
,ZZ: ;
column[[ 
:[[ 
x[[  !
=>[[" $
x[[% &
.[[& '
	AppUserId[[' 0
,[[0 1
principalTable\\ &
:\\& '
$str\\( /
,\\/ 0
principalColumn]] '
:]]' (
$str]]) -
,]]- .
onDelete^^  
:^^  !
ReferentialAction^^" 3
.^^3 4
Cascade^^4 ;
)^^; <
;^^< =
}__ 
)__ 
;__ 
migrationBuilderaa 
.aa 
CreateTableaa (
(aa( )
namebb 
:bb 
$strbb #
,bb# $
columnscc 
:cc 
tablecc 
=>cc !
newcc" %
{dd 
Idee 
=ee 
tableee 
.ee 
Columnee %
<ee% &
Guidee& *
>ee* +
(ee+ ,
typeee, 0
:ee0 1
$stree2 D
,eeD E
nullableeeF N
:eeN O
falseeeP U
)eeU V
,eeV W
TicketIdff 
=ff 
tableff $
.ff$ %
Columnff% +
<ff+ ,
Guidff, 0
>ff0 1
(ff1 2
typeff2 6
:ff6 7
$strff8 J
,ffJ K
nullableffL T
:ffT U
falseffV [
)ff[ \
,ff\ ]
FileUrlgg 
=gg 
tablegg #
.gg# $
Columngg$ *
<gg* +
stringgg+ 1
>gg1 2
(gg2 3
typegg3 7
:gg7 8
$strgg9 H
,ggH I
nullableggJ R
:ggR S
falseggT Y
)ggY Z
}hh 
,hh 
constraintsii 
:ii 
tableii "
=>ii# %
{jj 
tablekk 
.kk 

PrimaryKeykk $
(kk$ %
$strkk% 5
,kk5 6
xkk7 8
=>kk9 ;
xkk< =
.kk= >
Idkk> @
)kk@ A
;kkA B
tablell 
.ll 

ForeignKeyll $
(ll$ %
namemm 
:mm 
$strmm ?
,mm? @
columnnn 
:nn 
xnn  !
=>nn" $
xnn% &
.nn& '
TicketIdnn' /
,nn/ 0
principalTableoo &
:oo& '
$stroo( 1
,oo1 2
principalColumnpp '
:pp' (
$strpp) -
,pp- .
onDeleteqq  
:qq  !
ReferentialActionqq" 3
.qq3 4
Cascadeqq4 ;
)qq; <
;qq< =
}rr 
)rr 
;rr 
migrationBuildertt 
.tt 
CreateIndextt (
(tt( )
nameuu 
:uu 
$struu 2
,uu2 3
tablevv 
:vv 
$strvv &
,vv& '
columnww 
:ww 
$strww #
)ww# $
;ww$ %
migrationBuilderyy 
.yy 
CreateIndexyy (
(yy( )
namezz 
:zz 
$strzz /
,zz/ 0
table{{ 
:{{ 
$str{{ $
,{{$ %
column|| 
:|| 
$str|| "
)||" #
;||# $
migrationBuilder~~ 
.~~ 
CreateIndex~~ (
(~~( )
name 
: 
$str ,
,, -
table
€€ 
:
€€ 
$str
€€  
,
€€  !
column
 
:
 
$str
 #
)
# $
;
$ %
}
‚‚ 	
	protected
…… 
override
…… 
void
…… 
Down
……  $
(
……$ %
MigrationBuilder
……% 5
migrationBuilder
……6 F
)
……F G
{
†† 	
migrationBuilder
‡‡ 
.
‡‡ 
	DropTable
‡‡ &
(
‡‡& '
name
ˆˆ 
:
ˆˆ 
$str
ˆˆ 
)
ˆˆ 
;
ˆˆ 
migrationBuilder
ŠŠ 
.
ŠŠ 
	DropTable
ŠŠ &
(
ŠŠ& '
name
‹‹ 
:
‹‹ 
$str
‹‹ %
)
‹‹% &
;
‹‹& '
migrationBuilder
 
.
 
	DropTable
 &
(
& '
name
ŽŽ 
:
ŽŽ 
$str
ŽŽ #
)
ŽŽ# $
;
ŽŽ$ %
migrationBuilder
 
.
 
	DropTable
 &
(
& '
name
‘‘ 
:
‘‘ 
$str
‘‘ 
)
‘‘  
;
‘‘  !
migrationBuilder
““ 
.
““ 
	DropTable
““ &
(
““& '
name
”” 
:
”” 
$str
”” 
)
”” 
;
”” 
}
•• 	
}
–– 
}—— ²
>C:\ITDeskProject\ITDeskServer\Migrations\20231219142330_mg2.cs
	namespace 	
ITDeskServer
 
. 

Migrations !
{ 
public		 

partial		 
class		 
mg2		 
:		 
	Migration		 (
{

 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str $
,$ %
columns 
: 
table 
=> !
new" %
{ 
RoleId 
= 
table "
." #
Column# )
<) *
Guid* .
>. /
(/ 0
type0 4
:4 5
$str6 H
,H I
nullableJ R
:R S
falseT Y
)Y Z
,Z [
UserId 
= 
table "
." #
Column# )
<) *
Guid* .
>. /
(/ 0
type0 4
:4 5
$str6 H
,H I
nullableJ R
:R S
falseT Y
)Y Z
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% 6
,6 7
x8 9
=>: <
new= @
{A B
xC D
.D E
UserIdE K
,K L
xM N
.N O
RoleIdO U
}V W
)W X
;X Y
} 
) 
; 
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
	DropTable &
(& '
name 
: 
$str $
)$ %
;% &
}   	
}!! 
}"" 
>C:\ITDeskProject\ITDeskServer\Migrations\20231219142635_mg3.cs
	namespace 	
ITDeskServer
 
. 

Migrations !
{ 
public 

partial 
class 
mg3 
: 
	Migration (
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateIndex (
(( )
name 
: 
$str .
,. /
table 
: 
$str %
,% &
column 
: 
$str  
)  !
;! "
migrationBuilder 
. 
AddForeignKey *
(* +
name 
: 
$str 4
,4 5
table 
: 
$str %
,% &
column 
: 
$str  
,  !
principalTable 
: 
$str  '
,' (
principalColumn 
:  
$str! %
,% &
onDelete 
: 
ReferentialAction +
.+ ,
Cascade, 3
)3 4
;4 5
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
DropForeignKey +
(+ ,
name 
: 
$str 4
,4 5
table   
:   
$str   %
)  % &
;  & '
migrationBuilder"" 
."" 
	DropIndex"" &
(""& '
name## 
:## 
$str## .
,##. /
table$$ 
:$$ 
$str$$ %
)$$% &
;$$& '
}%% 	
}&& 
}'' Ó
/C:\ITDeskProject\ITDeskServer\Models\AppRole.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
AppRole 
: 
IdentityRole )
<) *
Guid* .
>. /
{ 
} £
/C:\ITDeskProject\ITDeskServer\Models\AppUser.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
AppUser 
: 
IdentityUser )
<) *
Guid* .
>. /
{ 
public 

string 
	FirstName 
{ 
get !
;! "
set# &
;& '
}( )
=* +
string, 2
.2 3
Empty3 8
;8 9
public		 

string		 
LastName		 
{		 
get		  
;		  !
set		" %
;		% &
}		' (
=		) *
string		+ 1
.		1 2
Empty		2 7
;		7 8
public

 

string

 
?

 
GoogleProvideId

 "
{

# $
get

% (
;

( )
set

* -
;

- .
}

/ 0
[ 
	NotMapped 
] 
public 

override 
bool  
PhoneNumberConfirmed -
{. /
get0 3
;3 4
set5 8
;8 9
}: ;
public 

string 
GetName 
( 
) 
{ 
return 
string 
. 
Join 
( 
$str 
, 
	FirstName  )
,) *
LastName+ 3
)3 4
;4 5
} 
} Ú
3C:\ITDeskProject\ITDeskServer\Models\AppUserRole.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
AppUserRole 
{ 
public 

Guid 
RoleId 
{ 
get 
; 
set !
;! "
}# $
public 

AppRole 
? 
Role 
{ 
get 
; 
set  #
;# $
}% &
public		 

Guid		 
UserId		 
{		 
get		 
;		 
set		 !
;		! "
}		# $
}

 Ù
.C:\ITDeskProject\ITDeskServer\Models\Ticket.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
Ticket 
{ 
public 

Guid 
Id 
{ 
get 
; 
set 
; 
}  
public 

Guid 
	AppUserId 
{ 
get 
;  
set! $
;$ %
}& '
public 

AppUser 
? 
AppUser 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
Subject 
{ 
get 
;  
set! $
;$ %
}& '
=( )
string* 0
.0 1
Empty1 6
;6 7
public		 

DateTime		 
CreatedDate		 
{		  !
get		" %
;		% &
set		' *
;		* +
}		, -
public

 

bool

 
IsOpen

 
{

 
get

 
;

 
set

 !
;

! "
}

# $
public 

List 
< 

TicketFile 
> 
? 
FileUrls %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
} ô
4C:\ITDeskProject\ITDeskServer\Models\TicketDetail.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
TicketDetail  
{ 
public 

TicketDetail 
( 
) 
{ 
Id 

= 
Guid 
. 
NewGuid 
( 
) 
; 
} 
public		 

Guid		 
Id		 
{		 
get		 
;		 
set		 
;		 
}		  
public

 

Guid

 
TicketId

 
{

 
get

 
;

 
set

  #
;

# $
}

% &
public 

Guid 
	AppUserId 
{ 
get 
;  
set! $
;$ %
}& '
public 

AppUser 
? 
AppUser 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
Content 
{ 
get  
;  !
set" %
;% &
}' (
=) *
string+ 1
.1 2
Empty2 7
;7 8
public 

DateTime 
CreatedDate 
{  !
get" %
;% &
set' *
;* +
}, -
} 
2C:\ITDeskProject\ITDeskServer\Models\TicketFile.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 

TicketFile 
{ 
public 

Guid 
Id 
{ 
get 
; 
set 
; 
}  
public 

Guid 
TicketId 
{ 
get 
; 
set  #
;# $
}% &
public 

string 
FileUrl 
{ 
get 
;  
set! $
;$ %
}& '
=( )
string* 0
.0 1
Empty1 6
;6 7
} è>
(C:\ITDeskProject\ITDeskServer\Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. 
AddCors 
( 
	configure "
=># %
{ 
	configure 
. 
AddDefaultPolicy 
( 
policy %
=>& (
{ 
policy 
. 	
AllowAnyHeader	 
( 
) 
. 	
AllowAnyOrigin	 
( 
) 
. 	
AllowAnyMethod	 
( 
) 
; 
} 
) 
; 
} 
) 
; 
builder 
. 
Services 
. 
TryAddScoped 
< 

JwtService (
>( )
() *
)* +
;+ ,
builder   
.   
Services   
.   
AddAuthentication   "
(  " #
)  # $
.  $ %
AddJwtBearer  % 1
(  1 2
options  2 9
=>  : <
{!! 
options"" 
."" %
TokenValidationParameters"" %
=""& '
new""( +
(""+ ,
)"", -
{## 
ValidateIssuer$$ 
=$$ 
true$$ 
,$$ 
ValidateAudience%% 
=%% 
true%% 
,%%  $
ValidateIssuerSigningKey&&  
=&&! "
true&&# '
,&&' (
ValidateLifetime'' 
='' 
true'' 
,''  
ValidIssuer(( 
=(( 
$str(( (
,((( )
ValidAudience)) 
=)) 
$str)) -
,))- .
IssuerSigningKey** 
=** 
new**  
SymmetricSecurityKey** 3
(**3 4
Encoding**4 <
.**< =
UTF8**= A
.**A B
GetBytes**B J
(**J K
$str	**K ¯
)
**¯ °
)
**° ±
}++ 
;++ 
},, 
),, 
;,, 
builder00 
.00 
Services00 
.00 
AddDbContext00 
<00 
AppDbContext00 *
>00* +
(00+ ,
options00, 3
=>004 6
{11 
options22 
.22 
UseSqlServer22 
(22 
$str	22 í
)
22í î
;
22î ï
}33 
)33 
;33 
builder55 
.55 
Services55 
.55 
AddIdentity55 
<55 
AppUser55 $
,55$ %
AppRole55& -
>55- .
(55. /
opt55/ 2
=>553 5
{66 
opt77 
.77 
Password77 
.77 
RequiredLength77 
=77  !
$num77" #
;77# $
opt88 
.88 
SignIn88 
.88 !
RequireConfirmedEmail88 $
=88% &
true88' +
;88+ ,
opt99 
.99 
Lockout99 
.99 "
DefaultLockoutTimeSpan99 &
=99' (
TimeSpan99) 1
.991 2
FromMinutes992 =
(99= >
$num99> ?
)99? @
;99@ A
opt:: 
.:: 
Lockout:: 
.:: #
MaxFailedAccessAttempts:: '
=::( )
$num::* +
;::+ ,
opt;; 
.;; 
Lockout;; 
.;; 
AllowedForNewUsers;; "
=;;# $
true;;% )
;;;) *
}== 
)== 
.>> $
AddEntityFrameworkStores>> 
<>> 
AppDbContext>> *
>>>* +
(>>+ ,
)>>, -
.?? $
AddDefaultTokenProviders?? 
(?? 
)?? 
;??  
builderCC 
.CC 
ServicesCC 
.CC 
AddControllersCC 
(CC  
)CC  !
.CC! "
AddODataCC" *
(CC* +
optionsCC+ 2
=>CC2 4
optionsCC4 ;
.CC; <
EnableQueryFeaturesCC< O
(CCO P
)CCP Q
)CCQ R
;CCR S
builderDD 
.DD 
ServicesDD 
.DD #
AddEndpointsApiExplorerDD (
(DD( )
)DD) *
;DD* +
builderEE 
.EE 
ServicesEE 
.EE 
AddSwaggerGenEE 
(EE 
setupEE $
=>EE% '
{FF 
varGG 
jwtSecurityShemeGG 
=GG 
newGG !
OpenApiSecuritySchemeGG 4
{HH 
BearerFormatII 
=II 
$strII 
,II 
NameJJ 
=JJ 
$strJJ #
,JJ# $
InKK 

=KK 
ParameterLocationKK 
.KK 
HeaderKK %
,KK% &
TypeLL 
=LL 
SecuritySchemeTypeLL !
.LL! "
HttpLL" &
,LL& '
SchemeMM 
=MM 
JwtBearerDefaultsMM "
.MM" # 
AuthenticationSchemeMM# 7
,MM7 8
DescriptionNN 
=NN 
$strNN O
,NNO P
	ReferencePP 
=PP 
newPP 
OpenApiReferencePP (
{QQ 	
IdRR 
=RR 
JwtBearerDefaultsRR "
.RR" # 
AuthenticationSchemeRR# 7
,RR7 8
TypeSS 
=SS 
ReferenceTypeSS  
.SS  !
SecuritySchemeSS! /
}TT 	
}UU 
;UU 
setupWW 	
.WW	 
!
AddSecurityDefinitionWW
 
(WW  
jwtSecurityShemeWW  0
.WW0 1
	ReferenceWW1 :
.WW: ;
IdWW; =
,WW= >
jwtSecurityShemeWW? O
)WWO P
;WWP Q
setupYY 	
.YY	 
"
AddSecurityRequirementYY
  
(YY  !
newYY! $&
OpenApiSecurityRequirementYY% ?
{ZZ 
{[[ 
jwtSecuritySheme[[ &
,[[& '
Array[[( -
.[[- .
Empty[[. 3
<[[3 4
string[[4 :
>[[: ;
([[; <
)[[< =
}[[> ?
}\\ 
)\\ 
;\\ 
}]] 
)]] 
;]] 
varcc 
appcc 
=cc 	
buildercc
 
.cc 
Buildcc 
(cc 
)cc 
;cc 
ifee 
(ee 
appee 
.ee 
Environmentee 
.ee 
IsDevelopmentee !
(ee! "
)ee" #
)ee# $
{ff 
appgg 
.gg 

UseSwaggergg 
(gg 
)gg 
;gg 
apphh 
.hh 
UseSwaggerUIhh 
(hh 
)hh 
;hh 
}ii 
appjj 
.jj 
UseCorsjj 
(jj 
)jj 
;jj 
appkk 
.kk 
UseHttpsRedirectionkk 
(kk 
)kk 
;kk 
appmm 
.mm 
UseAuthorizationmm 
(mm 
)mm 
;mm 
appoo 
.oo 
MapControllersoo 
(oo 
)oo 
;oo 
ExtensionsMiddlewareqq 
.qq 
AutoMigrationqq "
(qq" #
appqq# &
)qq& '
;qq' (
ExtensionsMiddlewarerr 
.rr 
CreateFirstUserrr $
(rr$ %
apprr% (
)rr( )
;rr) *
ExtensionsMiddlewaress 
.ss 
CreateRolesss  
(ss  !
appss! $
)ss$ %
;ss% &
ExtensionsMiddlewarett 
.tt 
CreateUserRolestt $
(tt$ %
apptt% (
)tt( )
;tt) *
appvv 
.vv 
Runvv 
(vv 
)vv 	
;vv	 
Ž!
4C:\ITDeskProject\ITDeskServer\Services\JwtService.cs
	namespace 	
ITDeskServer
 
. 
Services 
;  
public		 
sealed		 
class		 

JwtService		 
{

 
public 

string 
CreateToken 
( 
AppUser %
appUser& -
,- .
List/ 3
<3 4
string4 :
?: ;
>; <
?< =
roles> C
,D E
boolE I

rememberMeJ T
)T U
{ 
string 
token 
= 
string 
. 
Empty #
;# $
List 
< 
Claim 
> 
claims 
= 
new  
(  !
)! "
;" #
claims 
. 
Add 
( 
new 
( 
$str 
,  
appUser! (
.( )
Id) +
.+ ,
ToString, 4
(4 5
)5 6
)6 7
)7 8
;8 9
claims 
. 
Add 
( 
new 
( 
$str 
, 
appUser &
.& '
GetName' .
(. /
)/ 0
)0 1
)1 2
;2 3
claims 
. 
Add 
( 
new 
( 
$str 
, 
appUser  '
.' (
Email( -
??. 0
string1 7
.7 8
Empty8 =
)= >
)> ?
;? @
claims 
. 
Add 
( 
new 
( 
$str !
,! "
appUser# *
.* +
UserName+ 3
??4 6
string7 =
.= >
Empty> C
)C D
)D E
;E F
if 

(
 
roles 
is 
not 
null 
) 
claims $
.$ %
Add% (
(( )
new) ,
(, -
$str- 4
,4 5
string6 <
.< =
Join= A
(A B
$charB E
,E F
rolesG L
)L M
)M N
)N O
;O P
DateTime 
expires 
= 

rememberMe )
?* +
DateTime, 4
.4 5
Now5 8
.8 9
	AddMonths9 B
(B C
$numC D
)D E
:F G
DateTimeH P
.P Q
NowQ T
.T U
AddDaysU \
(\ ]
$num] ^
)^ _
;_ `
JwtSecurityToken 
jwtSecurityToken )
=* +
new, /
(/ 0
issuer 
: 
$str &
,& '
audience 
: 
$str *
,* +
claims 
: 
claims 
, 
	notBefore 
: 
DateTime 
. 
Now "
," #
expires 
: 
expires 
, 
signingCredentials 
: 
new "
SigningCredentials# 5
(5 6
new6 9 
SymmetricSecurityKey: N
(N O
EncodingO W
.W X
UTF8X \
.\ ]
GetBytes] e
(e f
$str	f Ê
)
Ê Ë
)
Ë Ì
,
Ì Í 
SecurityAlgorithms
Î à
.
à á

HmacSha512
á ë
)
ë ì
)
ì í
;
í î#
JwtSecurityTokenHandler   
handler    '
=  ( )
new  * -
(  - .
)  . /
;  / 0
token!! 
=!! 
handler!! 
.!! 

WriteToken!! !
(!!! "
jwtSecurityToken!!" 2
)!!2 3
;!!3 4
return$$ 
token$$ 
;$$ 
}%% 
}&& –
:C:\ITDeskProject\ITDeskServer\Validators\LoginValidator.cs
	namespace 	
ITDeskServer
 
. 
	Validator  
;  !
public 
sealed 
class 
LoginValidator "
:# $
AbstractValidator% 6
<6 7
LoginDto7 ?
>? @
{ 
public 

LoginValidator 
( 
) 
{		 
RuleFor

 
(

 
p

 
=>

 
p

 
.

 
UserNameOrEmail

 &
)

& '
.

' (
NotEmpty

( 0
(

0 1
)

1 2
.

2 3
WithMessage

3 >
(

> ?
$str

? t
)

t u
;

u v
RuleFor 
( 
p 
=> 
p 
. 
UserNameOrEmail %
)% &
.& '
MinimumLength' 4
(4 5
$num5 6
)6 7
.7 8
WithMessage8 C
(C D
$strD y
)y z
;z {
RuleFor 
( 
p 
=> 
p 
. 
Password 
)  
.  !
NotEmpty! )
() *
)* +
.+ ,
WithMessage, 7
(7 8
$str8 K
)K L
;L M
RuleFor 
( 
p 
=> 
p 
. 
Password 
) 
.  
Matches  '
(' (
$str( /
)/ 0
.0 1
WithMessage1 <
(< =
$str= i
)i j
;j k
RuleFor 
( 
p 
=> 
p 
. 
Password 
) 
.  
Matches  '
(' (
$str( /
)/ 0
.0 1
WithMessage1 <
(< =
$str= i
)i j
;j k
RuleFor 
( 
p 
=> 
p 
. 
Password 
) 
.  
Matches  '
(' (
$str( /
)/ 0
.0 1
WithMessage1 <
(< =
$str= d
)d e
;e f
RuleFor 
( 
p 
=> 
p 
. 
Password 
) 
.  
Matches  '
(' (
$str( 6
)6 7
.7 8
WithMessage8 C
(C D
$strD s
)s t
;t u
} 
} 